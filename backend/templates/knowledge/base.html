{% extends "base.html" %} {% block extra_head %}
<style>
  [x-cloak] {
    display: none !important;
  }
  /* --- Drop indicator styles --- */
  .drop-indicator-above::before {
    content: "";
    display: block;
    border-top: 2px solid #4a90e2; /* Bright blue for visibility */
    margin: 4px 0;
  }

  .drop-indicator-below::after {
    content: "";
    display: block;
    border-top: 2px solid #4a90e2;
    margin: 4px 0;
  }

  .drop-indicator-child {
    outline: 2px dashed #4a90e2;
    outline-offset: 2px;
  }

  /* Custom scrollbar styles */
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background-color: rgba(0, 0, 0, 0.3);
  }

  /* Hide scrollbar when not needed */
  .custom-scrollbar {
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
  }

  /* Code block styles */
  .prose pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .prose code {
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
</style>
<script>
  // Configure the FastAPI base URL
  const PROXY_SERVER_BASE_URL = "{{ PROXY_SERVER_BASE_URL }}";
  const PROXY_SERVER_API_KEY = "{{ PROXY_SERVER_API_KEY }}";

  // Add error handling for fetch calls
  const fetchWithErrorHandling = async (url, options) => {
    try {
      const response = await fetch(url, {
        ...options,
        credentials: "include",
        headers: {
          ...options.headers,
          "Content-Type": "application/json",
          "X-API-Key": PROXY_SERVER_API_KEY,
          "X-Requested-With": "XMLHttpRequest",
        },
      });
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response;
    } catch (error) {
      console.error("Fetch error:", error);
      throw error;
    }
  };

  // --- Drag & Drop functions with additional debug logging ---

  function handleDragStart(event) {
    event.target.classList.add("opacity-50");
    event.dataTransfer.setData("text/plain", event.target.dataset.pageId);
  }

  function handleDragEnd(event) {
    event.target.classList.remove("opacity-50");
    clearDropIndicators();
  }

  function clearDropIndicators() {
    document.querySelectorAll("[data-drop-zone]").forEach((el) => {
      el.classList.remove(
        "drop-indicator-child",
        "drop-indicator-above",
        "drop-indicator-below"
      );
    });
  }

  function handleDragOver(event) {
    event.preventDefault();
    clearDropIndicators();
    const dropZone = event.target.closest("[data-drop-zone]");
    if (!dropZone) return;
    const rect = dropZone.getBoundingClientRect();
    const offsetY = event.clientY - rect.top;
    const offsetX = event.clientX - rect.left;

    // Use 20% of dropzone width as threshold for child drop
    const childDropThreshold = rect.width * 0.2;

    if (offsetX > childDropThreshold) {
      dropZone.classList.add("drop-indicator-child");
    } else {
      if (offsetY < rect.height / 3) {
        dropZone.classList.add("drop-indicator-above");
      } else if (offsetY > (rect.height * 2) / 3) {
        dropZone.classList.add("drop-indicator-below");
      }
    }
  }

  function handleDragLeave(event) {
    const dropZone = event.target.closest("[data-drop-zone]");
    if (dropZone) {
      dropZone.classList.remove(
        "drop-indicator-child",
        "drop-indicator-above",
        "drop-indicator-below"
      );
    }
  }

  function handleDrop(event) {
    event.preventDefault();
    clearDropIndicators();

    const dropZone = event.target.closest("[data-drop-zone]");
    if (!dropZone) return;

    const draggedPageId = event.dataTransfer.getData("text/plain");
    const draggedLi = document.querySelector(
      `li[data-drop-zone][data-page-id="${draggedPageId}"]`
    );
    if (!draggedLi) return;

    let newParentId = null;
    let newPosition = 0;
    let targetContainer = null;
    const rect = dropZone.getBoundingClientRect();
    const offsetX = event.clientX - rect.left;
    const offsetY = event.clientY - rect.top;

    // If horizontal offset is greater than 50 pixels, treat drop as a request
    // to make the dropZone a parent (i.e. drop as a child of that page).
    if (offsetX > 50) {
      newParentId = dropZone.dataset.pageId; // intended parent id
      targetContainer = dropZone.querySelector("ul");
      if (!targetContainer) {
        targetContainer = document.createElement("ul");
        targetContainer.classList.add("ml-4", "mt-0.5", "space-y-0.5");
        targetContainer.setAttribute("data-parent-id", newParentId);
        dropZone.appendChild(targetContainer);
      }
      newPosition = targetContainer.children.length; // append at the end
    } else {
      // Otherwise, reordering within the same container.
      targetContainer = dropZone.parentElement; // should be a UL
      newParentId = targetContainer.getAttribute("data-parent-id") || null;
      const childrenArray = Array.from(
        targetContainer.querySelectorAll(":scope > li[data-drop-zone]")
      );
      const index = childrenArray.indexOf(dropZone);
      if (offsetY > rect.height / 2) {
        newPosition = index + 1;
      } else {
        newPosition = index;
      }
    }

    // Determine old parent based on current container.
    const oldContainer = draggedLi.parentElement;
    const oldParentId = oldContainer.getAttribute("data-parent-id") || null;

    // Remove the dragged element from its current container.
    draggedLi.remove();
    if (newPosition >= targetContainer.children.length) {
      targetContainer.appendChild(draggedLi);
    } else {
      targetContainer.insertBefore(
        draggedLi,
        targetContainer.children[newPosition]
      );
    }

    // Send the new ordering to the backend.
    fetch("{% url 'knowledge_list' organization_pk=organization.pk %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
          .value,
      },
      body: JSON.stringify({
        action: "reorder",
        page_id: draggedPageId,
        parent_id: newParentId,
        position: newPosition,
        old_parent_id: oldParentId,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "success") {
          window.location.reload(); // Force refresh to sync with server
        } else {
          console.error("Reorder failed:", data.message);
        }
      })
      .catch((error) => console.error("Error:", error));
  }
</script>
{% endblock %} {% block content %}
<div
  class="flex flex-col h-[calc(100vh-4rem)]"
  x-data="{ showSearchModal: false }"
>
  {% csrf_token %}
  <meta name="selected-version" content="{{ selected_version_id }}" />
  <!-- Main content area -->
  <div class="flex-1 flex overflow-hidden">
    <!-- Workspace sidebar -->
    <aside class="w-64 bg-base-200 border-r flex flex-col">
      <!-- Fixed sections -->
      <div class="flex-none p-2">
        <!-- Agent Settings Section -->
        <div>
          <div class="px-2">
            <button
              onclick="redirectToAgentSettings()"
              class="w-full flex items-center justify-between px-3 py-1.5 text-xs font-semibold text-base-content/50 uppercase tracking-wider hover:bg-base-300 rounded-lg"
            >
              <span>Agent</span>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"
                />
              </svg>
            </button>
          </div>
          <div class="px-4 h-[1px] bg-base-300 my-2"></div>
        </div>

        <!-- Search Section -->
        <div>
          <div class="px-2">
            <button
              class="w-full flex items-center justify-between px-3 py-1.5 text-xs font-semibold text-base-content/50 uppercase tracking-wider hover:bg-base-300 rounded-lg"
              @click="showSearchModal = true"
            >
              <span>Search</span>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
                />
              </svg>
            </button>
          </div>
          <div class="px-4 h-[1px] bg-base-300 my-2"></div>
        </div>

        <!-- Knowledge Base Header -->
        <div class="px-2">
          <button
            @click.prevent="createNewPage()"
            class="w-full flex items-center justify-between px-3 py-1.5 text-xs font-semibold text-base-content/50 uppercase tracking-wider hover:bg-base-300 rounded-lg"
          >
            <span>Knowledge Base</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 4.5v15m7.5-7.5h-15"
              />
            </svg>
          </button>
        </div>
      </div>

      <!-- Scrollable knowledge base items -->
      <div class="flex-1 overflow-y-auto custom-scrollbar">
        <div class="px-2">
          <ul class="space-y-0.5 knowledge-base-items">
            {% for page in pages %}
            <li
              class="group relative"
              x-data="{ showMenu: false }"
              data-drop-zone
              data-page-id="{{ page.pk }}"
              ondragover="handleDragOver(event)"
              ondragleave="handleDragLeave(event)"
              ondrop="handleDrop(event)"
            >
              <div
                class="flex items-center rounded-lg transition-colors hover:bg-base-300 {% if page.pk == current_page.pk %}bg-base-300{% endif %}"
              >
                <a
                  href="{% url 'page_detail' organization_pk=organization.pk pk=page.pk %}"
                  class="flex-grow block px-3 py-1.5 text-sm cursor-move"
                  draggable="true"
                  ondragstart="handleDragStart(event)"
                  ondragend="handleDragEnd(event)"
                  data-page-id="{{ page.pk }}"
                >
                  <span>{{ page.title }}</span>
                </a>
                <div class="hidden group-hover:flex items-center pr-2">
                  <!-- Add button -->
                  <button class="p-1 hover:bg-base-content/10 rounded-lg">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-4 w-4"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 4.5v15m7.5-7.5h-15"
                      />
                    </svg>
                  </button>
                  <!-- Menu button -->
                  <div class="relative">
                    <button
                      @click="showMenu = !showMenu"
                      class="p-1 hover:bg-base-content/10 rounded-lg"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z"
                        />
                      </svg>
                    </button>
                    <!-- Dropdown menu -->
                    <div
                      x-show="showMenu"
                      @click.away="showMenu = false"
                      x-transition:enter="transition ease-out duration-100"
                      x-transition:enter-start="transform opacity-0 scale-95"
                      x-transition:enter-end="transform opacity-100 scale-100"
                      x-transition:leave="transition ease-in duration-75"
                      x-transition:leave-start="transform opacity-100 scale-100"
                      x-transition:leave-end="transform opacity-0 scale-95"
                      class="absolute right-0 mt-2 w-48 rounded-lg shadow-lg bg-base-100 ring-1 ring-black ring-opacity-5 z-50"
                    >
                      <div class="py-1">
                        <a
                          href="{% url 'page_update' organization_pk=organization.pk pk=page.pk %}"
                          class="block px-4 py-2 text-sm hover:bg-base-200"
                        >
                          Edit page
                        </a>
                        <a
                          href="{% url 'page_delete' organization_pk=organization.pk pk=page.pk %}"
                          class="block px-4 py-2 text-sm text-error hover:bg-base-200"
                        >
                          Delete page
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Child pages container -->
              {% if page.children.exists %}
              <ul
                class="ml-4 mt-0.5 space-y-0.5"
                data-parent-id="{{ page.pk }}"
              >
                {% for child in page.children.all %}
                <li
                  class="group relative"
                  x-data="{ showMenu: false }"
                  data-drop-zone
                  data-page-id="{{ child.pk }}"
                  ondragover="handleDragOver(event)"
                  ondragleave="handleDragLeave(event)"
                  ondrop="handleDrop(event)"
                >
                  <!-- Similar structure as parent, but with child page data -->
                  <div
                    class="flex items-center rounded-lg transition-colors hover:bg-base-300 {% if child.pk == current_page.pk %}bg-base-300{% endif %}"
                  >
                    <a
                      href="{% url 'page_detail' organization_pk=organization.pk pk=child.pk %}"
                      class="flex-grow block px-3 py-1.5 text-sm cursor-move"
                      draggable="true"
                      ondragstart="handleDragStart(event)"
                      ondragend="handleDragEnd(event)"
                      data-page-id="{{ child.pk }}"
                    >
                      <span>{{ child.title }}</span>
                    </a>
                    <!-- ... Child menu buttons ... -->
                  </div>
                </li>
                {% endfor %}
              </ul>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </aside>

    <!-- Content area -->
    <div class="flex-1 overflow-y-auto custom-scrollbar bg-white">
      {% block knowledge_content %}{% endblock %}
    </div>

    <!-- Chat Interface -->
    <div
      class="w-2/5 border-l flex flex-col"
      x-data="chatInterface()"
      x-init="initializeChat()"
    >
      <!-- Chat messages area - scrollable -->
      <div
        class="flex-1 overflow-y-auto custom-scrollbar"
        x-ref="messagesContainer"
      >
        <div class="min-h-full flex flex-col justify-end">
          <template x-for="message in messages" :key="message.id">
            <!-- Message container -->
            <div
              class="flex px-4 py-8 sm:px-6"
              :class="{
                'bg-base-200': message.message_type === 'ai',
                'bg-error/10': message.message_type === 'comment'
              }"
            >
              <img
                class="mr-2 flex h-8 w-8 rounded-full sm:mr-4"
                :src="message.message_type === 'human' ? 'https://dummyimage.com/256x256/363536/ffffff&text=U' : message.message_type === 'ai' ? 'https://dummyimage.com/256x256/354ea1/ffffff&text=A' : 'https://dummyimage.com/256x256/dc2626/ffffff&text=S'"
                :alt="message.message_type === 'human' ? 'User' : message.message_type === 'ai' ? 'Assistant' : 'System'"
              />
              <div class="flex w-full flex-col">
                <!-- Regular message content -->
                <template x-if="message.message_type !== 'comment'">
                  <p class="max-w-3xl" x-text="message.content"></p>
                </template>

                <!-- Comment message with text and error -->
                <template x-if="message.message_type === 'comment'">
                  <div class="flex flex-col gap-4">
                    <template x-if="message.text">
                      <p
                        class="max-w-3xl text-error-content"
                        x-text="message.text"
                      ></p>
                    </template>
                    <template x-if="message.error">
                      <div class="bg-base-100 rounded-lg p-4">
                        <p
                          class="font-mono text-sm text-error"
                          x-text="message.error"
                        ></p>
                      </div>
                    </template>
                  </div>
                </template>

                <template x-if="message.message_type === 'ai'">
                  <div class="flex justify-end mt-4">
                    <button class="text-base-content/50 hover:text-primary">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"
                        />
                      </svg>
                    </button>
                  </div>
                </template>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Chat input area - fixed at bottom -->
      <div class="flex-none border-t">
        <div class="p-4 bg-base-100">
          <div class="relative">
            <textarea
              x-model="newMessage"
              @keydown.enter.prevent="sendMessage()"
              class="textarea w-full min-h-[4.5rem] bg-base-200 pr-12 border-none"
              placeholder="Type your message here..."
              rows="2"
            ></textarea>
            <div class="absolute bottom-2 left-2">
              <button class="btn btn-ghost btn-sm">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"
                  />
                </svg>
              </button>
            </div>
            <div class="absolute bottom-2 right-2">
              <button
                @click="sendMessage()"
                class="btn btn-ghost btn-sm"
                :disabled="isLoading || !newMessage.trim()"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Status footer -->
        <div
          class="px-4 py-2 bg-base-100 text-xs text-base-content/70 flex items-center justify-center gap-2"
        >
          <div
            class="w-2 h-2 rounded-full"
            :class="{'bg-success': !isLoading, 'bg-warning animate-pulse': isLoading}"
          ></div>
          <span
            x-text="isLoading ? 'The agent is thinking...' : 'The agent is using the last version of Knowledge'"
          ></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Search Modal -->
  <div
    x-cloak
    x-show="showSearchModal"
    class="fixed inset-0 bg-black/50 z-50 flex items-start justify-center pt-[20vh]"
    @click="showSearchModal = false"
    @keydown.escape.window="showSearchModal = false"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
  >
    <div class="w-[640px] bg-base-100 rounded-xl shadow-2xl" @click.stop>
      <div class="p-4">
        <form
          method="GET"
          action="{% url 'knowledge_list' organization_pk=organization.pk %}"
        >
          <div class="relative">
            <input
              type="text"
              name="q"
              class="input input-lg w-full pl-12 bg-base-200 border-none"
              placeholder="Search knowledge..."
              @keydown.escape.stop="showSearchModal = false"
              x-ref="searchInput"
              x-init="$nextTick(() => { if(showSearchModal) $refs.searchInput.focus() })"
            />
            <div
              class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6 text-base-content/50"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
                />
              </svg>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  const chatInterface = () => ({
    threadId: null,
    messages: [],
    newMessage: "",
    isStreaming: false,
    isLoading: false,
    error: null,

    async initializeChat() {
      try {
        const response = await fetchWithErrorHandling(
          `${PROXY_SERVER_BASE_URL}/threads`,
          {
            method: "POST",
            body: JSON.stringify({
              contact_name: "Admin Chat",
              contact_identifier: "admin",
            }),
          }
        );
        const data = await response.json();
        this.threadId = data.thread_id;
      } catch (err) {
        console.error("Chat initialization error:", err);
        this.error = err.message;
      }
    },

    async sendMessage() {
      if (!this.newMessage.trim()) return;
      const userMessage = {
        id: Date.now(),
        message_type: "human",
        content: this.newMessage,
        timestamp: new Date().toLocaleTimeString(),
      };
      this.messages.push(userMessage);
      const messageText = this.newMessage;
      this.newMessage = "";
      this.isLoading = true;
      this.error = null;
      this.scrollToBottom();

      try {
        const response = await fetchWithErrorHandling(
          `${PROXY_SERVER_BASE_URL}/threads/${this.threadId}/messages`,
          {
            method: "POST",
            body: JSON.stringify({
              message_type: "human",
              content: [{ type: "text", text: messageText }],
            }),
          }
        );
        await response.json();
        await this.startStreaming();
      } catch (err) {
        console.error("Send message error:", err);
        this.error = err.message;
      } finally {
        this.isLoading = false;
      }
    },

    async startStreaming() {
      try {
        this.isStreaming = true;
        const response = await fetchWithErrorHandling(
          `${PROXY_SERVER_BASE_URL}/threads/${this.threadId}/run`,
          {
            method: "POST",
            body: JSON.stringify({
              agent_version: "{{ selected_version_slug }}",
            }),
          }
        );

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });

          // Process complete messages
          while (true) {
            const newlineIndex = buffer.indexOf("\n");
            if (newlineIndex === -1) break;

            const line = buffer.slice(0, newlineIndex).trim();
            buffer = buffer.slice(newlineIndex + 1);

            if (line.startsWith("data: ")) {
              try {
                const jsonData = line.slice(6); // Remove 'data: ' prefix
                const parsed = JSON.parse(jsonData);

                // Process each complete message that should be sent
                if (parsed.should_send && parsed.message) {
                  // Collect all text content from the message
                  const textContent = parsed.message.content
                    .filter((item) => item.type === "text")
                    .map((item) => item.text)
                    .join("");

                  if (textContent) {
                    // Create a new message for each complete response
                    const newMessage = {
                      id: Date.now() + Math.random(),
                      message_type: parsed.message.message_type,
                      content: textContent,
                      timestamp: new Date().toLocaleTimeString(),
                    };
                    this.messages.push(newMessage);
                    this.scrollToBottom();
                  }
                }

                // Handle comment messages (including errors) regardless of should_send flag
                if (parsed.message?.message_type === "comment") {
                  const textContent = parsed.message.content.find(
                    (item) => item.type === "text"
                  )?.text;
                  const errorContent = parsed.message.content.find(
                    (item) => item.type === "error"
                  )?.error;

                  if (textContent || errorContent) {
                    const newMessage = {
                      id: Date.now() + Math.random(),
                      message_type: "comment",
                      text: textContent,
                      error: errorContent,
                      timestamp: new Date().toLocaleTimeString(),
                    };
                    this.messages.push(newMessage);
                    this.scrollToBottom();
                  }
                }
              } catch (e) {
                console.error("Stream parse error", e);
              }
            }
          }
        }

        this.isStreaming = false;
        this.scrollToBottom();
      } catch (err) {
        this.error = "Stream error: " + err.message;
        this.isStreaming = false;
      }
    },

    scrollToBottom() {
      this.$nextTick(() => {
        const container = this.$refs.messagesContainer;
        if (container) {
          container.scrollTop = container.scrollHeight;
        }
      });
    },
  });

  function createNewPage() {
    const version = document.querySelector(
      'meta[name="selected-version"]'
    )?.content;
    const page = {
      title: "New Page",
      content: "# New Page\n\nStart writing here...",
      version: version,
    };

    fetch("{% url 'knowledge_list' organization_pk=organization.pk %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
          .value,
      },
      body: JSON.stringify(page),
    })
      .then((response) => {
        if (!response.ok) {
          return response.text().then((text) => {
            throw new Error(
              `Network response was not ok (${response.status}): ${text}`
            );
          });
        }
        return response.json();
      })
      .then((data) => {
        if (data.status === "success") {
          window.location.reload();
        } else {
          throw new Error(data.message || "Unknown error occurred");
        }
      })
      .catch((error) => {
        console.error("Detailed error in createNewPage:", {
          message: error.message,
          stack: error.stack,
        });
      });
  }

  function redirectToAgentSettings() {
    window.location.href =
      "{% url 'agent_setting_update' organization_pk=organization.pk %}";
  }
</script>
{% endblock %}
